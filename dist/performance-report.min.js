"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};function randomString(len){len=len||19;for(var $chars="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz123456789",maxPos=$chars.length,pwd="",i=0;i<len;i++)pwd+=$chars.charAt(Math.floor(Math.random()*maxPos));return pwd+(new Date).getTime()}function Performance(option,fn){try{var reportData=function(){setTimeout(function(){opt.isPage&&perforPage(),(opt.isResource||opt.isAjax)&&perforResource(),ERRORLIST&&ERRORLIST.length&&(conf.errorList=conf.errorList.concat(ERRORLIST));var w=document.documentElement.clientWidth||document.body.clientWidth,h=document.documentElement.clientHeight||document.body.clientHeight,markUser=sessionStorage.getItem("markUser");markUser||sessionStorage.setItem("markUser",randomString());var result={time:(new Date).getTime(),page:conf.page,preUrl:conf.preUrl,appVersion:conf.appVersion,errorList:conf.errorList,performance:conf.performance,resourceList:conf.resourceList,addData:ADDDATA,markPage:randomString(),markUser:markUser,screenwidth:w,screenheight:h};result=Object.assign(result,opt.add),fn&&fn(result),!fn&&window.fetch&&fetch(opt.domain,{method:"POST",headers:{"Content-Type":"application/json"},type:"report-data",body:JSON.stringify(result)})},opt.outtime)},getLargeTime=function(){conf.haveAjax&&conf.haveFetch&&loadTime&&ajaxTime&&fetchTime?(console.log("loadTime:"+loadTime+",ajaxTime:"+ajaxTime+",fetchTime:"+fetchTime),reportData()):conf.haveAjax&&!conf.haveFetch&&loadTime&&ajaxTime?(console.log("loadTime:"+loadTime+",ajaxTime:"+ajaxTime),reportData()):!conf.haveAjax&&conf.haveFetch&&loadTime&&fetchTime?(console.log("loadTime:"+loadTime+",fetchTime:"+fetchTime),reportData()):conf.haveAjax||conf.haveFetch||!loadTime||(console.log("loadTime:"+loadTime),reportData())},perforPage=function(){if(window.performance){var timing=performance.timing;conf.performance={dnst:timing.domainLookupEnd-timing.domainLookupStart||0,tcpt:timing.connectEnd-timing.connectStart||0,wit:timing.responseStart-timing.navigationStart||0,domt:timing.domContentLoadedEventEnd-timing.navigationStart||0,lodt:timing.loadEventEnd-timing.navigationStart||0,radt:timing.fetchStart-timing.navigationStart||0,rdit:timing.redirectEnd-timing.redirectStart||0,uodt:timing.unloadEventEnd-timing.unloadEventStart||0,reqt:timing.responseEnd-timing.requestStart||0,andt:timing.domComplete-timing.domInteractive||0}}},perforResource=function(){if(!window.performance&&!window.performance.getEntries)return!1;var resource=performance.getEntriesByType("resource"),resourceList=[];if(!resource&&!resource.length)return resourceList;resource.forEach(function(item){if((opt.isAjax||"xmlhttprequest"!=item.initiatorType&&"fetchrequest"!=item.initiatorType)&&(opt.isResource||"xmlhttprequest"==item.initiatorType||"fetchrequest"===item.initiatorType)){var json={name:item.name,method:"GET",type:item.initiatorType,duration:item.duration.toFixed(2)||0,decodedBodySize:item.decodedBodySize||0,nextHopProtocol:item.nextHopProtocol};if(conf.ajaxMsg&&conf.ajaxMsg.length)for(var i=0,len=conf.ajaxMsg.length;i<len;i++)conf.ajaxMsg[i].url===item.name&&(json.method=conf.ajaxMsg[i].method||"GET",json.type=conf.ajaxMsg[i].type||json.type);resourceList.push(json)}}),conf.resourceList=resourceList},fetArg=function(arg){var result={method:"GET",type:"fetchrequest"},args=Array.prototype.slice.apply(arg);if(!args||!args.length)return result;try{1===args.length?"string"==typeof args[0]?result.url=args[0]:"object"===_typeof(args[0])&&(result.url=args[0].url,result.method=args[0].method):(result.url=args[0],result.method=args[1].method,result.type=args[1].type)}catch(err){}return result},ajaxResponse=function(xhr,type){var defaults=Object.assign({},errordefo);defaults.t=(new Date).getTime(),defaults.n="ajax",defaults.msg=xhr.statusText||"ajax request error",defaults.method=xhr.method,defaults.data={resourceUrl:xhr.responseURL,text:xhr.statusText,status:xhr.status},conf.errorList.push(defaults)},getFetchTime=function(type){conf.fetchNum+=1,conf.fetLength===conf.fetchNum&&("success"==type?console.log("走了 fetch success 方法"):console.log("走了 fetch error 方法"),conf.fetchNum=conf.fetLength=0,fetchTime=(new Date).getTime()-beginTime,getLargeTime())},getAjaxTime=function(type){conf.loadNum+=1,conf.loadNum===conf.ajaxLength&&("load"==type?console.log("走了AJAX onload 方法"):"readychange"==type?console.log("走了AJAX onreadystatechange 方法"):console.log("走了 error 方法"),conf.ajaxLength=conf.loadNum=0,ajaxTime=(new Date).getTime()-beginTime,getLargeTime())},clearPerformance=function(type){(window.performance||window.performance.clearResourceTimings)&&(conf.haveAjax&&conf.haveFetch&&0==conf.ajaxLength&&0==conf.fetLength?clear():!conf.haveAjax&&conf.haveFetch&&0==conf.fetLength?clear():conf.haveAjax&&!conf.haveFetch&&0==conf.ajaxLength&&clear())},clear=function(){performance.clearResourceTimings(),conf.performance={},conf.errorList=[],conf.preUrl="",conf.resourceList="",conf.page=location.href,ERRORLIST=[],ADDDATA=[]},opt={domain:"http://localhost/api",outtime:300,filterUrl:["http://localhost:35729/livereload.js?snipver=1","http://localhost:8000/sockjs-node/info"],isPage:!0,isAjax:!0,isResource:!0,isError:!0,add:{}};opt=Object.assign(opt,option);var conf={resourceList:[],performance:{},errorList:[],fetchNum:0,loadNum:0,ajaxLength:0,fetLength:0,ajaxMsg:[],goingType:"",haveAjax:!1,haveFetch:!1,preUrl:document.referrer&&document.referrer!==location.href?document.referrer:"",appVersion:navigator.appVersion,page:location.href},errordefo={t:"",n:"js",msg:"",data:{}},beginTime=(new Date).getTime(),loadTime=0,ajaxTime=0,fetchTime=0;opt.isError&&(window.addEventListener("error",function(e){var defaults=Object.assign({},errordefo);defaults.n="resource",defaults.t=(new Date).getTime(),defaults.msg=e.target.localName+" is load error",defaults.method="GET",defaults.data={target:e.target.localName,type:e.type,resourceUrl:e.target.href||e.target.currentSrc},e.target!=window&&conf.errorList.push(defaults)},!0),window.onerror=function(msg,_url,line,col,error){var defaults=Object.assign({},errordefo);setTimeout(function(){col=col||window.event&&window.event.errorCharacter||0,defaults.msg=error&&error.stack?error.stack.toString():msg,defaults.method="GET",defaults.data={resourceUrl:_url,line:line,col:col},defaults.t=(new Date).getTime(),conf.errorList.push(defaults)},0)}),addEventListener("load",function(){loadTime=(new Date).getTime()-beginTime,getLargeTime()},!1),(opt.isAjax||opt.isError)&&function(){if(window.fetch){var _fetch=fetch;window.fetch=function(){var result=fetArg(arguments);return"report-data"!==result.type&&(clearPerformance(),conf.ajaxMsg.push(result),conf.fetLength=conf.fetLength+1,conf.haveFetch=!0),_fetch.apply(this,arguments).then(function(res){if("report-data"!==result.type)return getFetchTime("success"),res}).catch(function(err){if("report-data"!==result.type){getFetchTime("error");var defaults=Object.assign({},errordefo);return defaults.t=(new Date).getTime(),defaults.n="fetch",defaults.msg="fetch request error",defaults.method=result.method,defaults.data={resourceUrl:result.url,text:err.stack||err,status:0},conf.errorList.push(defaults),err}})}}}(),(opt.isAjax||opt.isError)&&function(funs){function getFactory(attr){return function(){return this.hasOwnProperty(attr+"_")?this[attr+"_"]:this.xhr[attr]}}function setFactory(attr){return function(f){var xhr=this.xhr,that=this;0==attr.indexOf("on")?funs[attr]?xhr[attr]=function(){funs[attr](that)||f.apply(xhr,arguments)}:xhr[attr]=f:this[attr+"_"]=f}}function hookfun(fun){return function(){var args=[].slice.call(arguments);if(!funs[fun]||!funs[fun].call(this,args,this.xhr))return this.xhr[fun].apply(this.xhr,args)}}window._ahrealxhr=window._ahrealxhr||XMLHttpRequest,XMLHttpRequest=function(){for(var attr in this.xhr=new window._ahrealxhr,this.xhr){var type="";try{type=_typeof(this.xhr[attr])}catch(e){}"function"===type?this[attr]=hookfun(attr):Object.defineProperty(this,attr,{get:getFactory(attr),set:setFactory(attr)})}},window._ahrealxhr}({onreadystatechange:function(xhr){4===xhr.readyState&&setTimeout(function(){"load"!==conf.goingType&&(conf.goingType="readychange",getAjaxTime("readychange"),(xhr.status<200||300<xhr.status)&&(xhr.method=xhr.args.method,ajaxResponse(xhr)))},600)},onerror:function(xhr){getAjaxTime("error"),xhr.args&&(xhr.method=xhr.args.method,xhr.responseURL=xhr.args.url,xhr.statusText="ajax request error"),ajaxResponse(xhr)},onload:function(xhr){if(4===xhr.readyState){if("readychange"===conf.goingType)return;conf.goingType="load",getAjaxTime("load"),(xhr.status<200||300<xhr.status)&&(xhr.method=xhr.args.method,ajaxResponse(xhr))}},open:function(arg,xhr){if(opt.filterUrl&&opt.filterUrl.length){var begin=!1;if(opt.filterUrl.forEach(function(item){-1!=arg[1].indexOf(item)&&(begin=!0)}),begin)return}var result={url:arg[1],method:arg[0]||"GET",type:"xmlhttprequest"};this.args=result,clearPerformance(),conf.ajaxMsg.push(result),conf.ajaxLength=conf.ajaxLength+1,conf.haveAjax=!0}})}catch(err){}}"function"==typeof require&&"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"object"===("undefined"==typeof module?"undefined":_typeof(module))?module.exports=Performance:window.Performance=Performance,window.ERRORLIST=[],window.ADDDATA={},Performance.addError=function(err){err={method:"GET",msg:err.msg,n:"js",data:{col:err.col,line:err.line,resourceUrl:err.resourceUrl}},ERRORLIST.push(err)},Performance.addData=function(fn){fn&&fn(ADDDATA)};